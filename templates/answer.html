<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../static/css/answer.css">
    <title>Quiz</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="header">
        <h1>CSE 312</h1>
    </div>

    <div id="questions-container">
        {% for question in questions %}
        <div class="question" id="question-{{ question._id }}">
            {% if question.image_path %}
            <p>Q:</p>
            <img src="{{ question.image_path }}" alt="Question Image" class="question-image">
            {% endif %}
            {% if question.question %}
            <p>Q: {{ question.question }}</p>
            {% endif %}
            <!-- Display who posted the question -->
            <p>Posted by: {{ question.username }}</p>
            <!-- Display the answer count -->
            <p>Answers submitted: {{ question.answer_count }}</p>
            <!-- Timer display -->
            <p>Timer: <span id="timer-{{ question._id }}">30</span> seconds</p>
            <form onsubmit="submitAnswer(event, this, '{{ question._id }}'); return false;" data-question-id="{{ question._id }}">
                {% for answer in question.answers %}
                <label class="answer-option">
                    <input type="radio" name="answer-{{ question._id }}" value="{{ loop.index0 }}">
                    {{ answer }}
                </label>
                {% endfor %}
                <button type="submit">Submit Answer</button>
            </form>

            <!-- Results dropdown -->
            <div class="results-dropdown">
                <button class="results-btn" id= "resultsButton" style="display: none;" onclick="toggleResults('{{ question._id }}')">Show Results</button>
                <div class="results-content" id="results-content-{{ question._id }}">
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <script>
        async function submitAnswer(event, form, questionId) {
            event.preventDefault(); // Prevent the default form submission
        
            // Find the selected answer
            const selectedAnswer = form.querySelector(`input[name="answer-${questionId}"]:checked`).value;
        
            // Prepare the data to be sent
            const data = {
                questionId: questionId,
                answerIndex: parseInt(selectedAnswer, 10) // Ensure answerIndex is an integer
            };
        
            try {
                // Send the data using the Fetch API to the correct endpoint
                const response = await fetch('/validate-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
        
                if (response.ok) {
                    // Handle the response from the server
                    const result = await response.json();
                    alert(result.message); // For example, alert the user with the result message
                    // Optionally, redirect or update the UI based on the result
                } else {
                    // Handle server errors or invalid responses
                    console.error('Submission failed', await response.text());
                }
            } catch (error) {
                // Handle network errors
                console.error('Network error:', error);
            }
        }

        function startTimer(questionId) {
            let timeLeft = 30;
            const timerElement = document.getElementById(`timer-${questionId}`);
            const timer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    // Optionally, handle the timeout event, e.g., disable the submit button
                    const submitButton = document.querySelector(`form[data-question-id="${questionId}"] button[type="submit"]`);
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.textContent = 'Time Up';
                    }
                    // Show the Results button for the specific question
                    const resultsButton = document.querySelector(`#question-${questionId} .results-btn`);
                    if (resultsButton) {
                        resultsButton.style.display = 'inline'; 
                    }
                }
            }, 1000);
        }

        // Call startTimer for each question when the page loads or when a new question is added
        document.querySelectorAll('.question').forEach(question => {
            const questionId = question.id.split('-')[1]; // Assuming the id of the question div is 'question-<questionId>'
            startTimer(questionId);
        });
    </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
    var socket = io();
    socket.on('connect', function() {
        socket.emit('my event', {data: 'I\'m connected!'});
        
    });

    

    // function update_Questions(){
    //     socket.emit('message', {data: 'updating questions...'})
    // }
    // setInterval(update_Questions, 2000);

    socket.on('update_question', function(new_question) {
        console.log(new_question);
        const questionJSON = JSON.parse(new_question);
        const oldquestions = document.getElementById("questions-container");

        // Check if the question already exists to prevent duplication
        if (!document.getElementById(`question-${questionJSON._id}`)) {
            let newQuestionHTML = `<div class='question' id='question-${questionJSON._id}'>
                <p>Q: ${questionJSON.question}</p>
                <p>Posted by: ${questionJSON.username}</p>
                <p>Answers submitted: ${questionJSON.answer_count}</p>
                <p>Timer: <span id="timer-${questionJSON._id}">30</span> seconds</p>
                <form onsubmit='submitAnswer(event, this, "${questionJSON._id}"); return false;' data-question-id="${questionJSON._id}">`;

            // Loop through each answer and append it
            questionJSON.answers.forEach((answer, index) => {
                newQuestionHTML += `<label class='answer-option'>
                    <input type='radio' name='answer-${questionJSON._id}' value='${index}'>
                    ${answer}
                </label>`;
            });

            newQuestionHTML += `<button type='submit'>Submit Answer</button></form></div>`;

            oldquestions.innerHTML += newQuestionHTML;
            startTimer(questionJSON._id); // Start the timer for the new question
        }
    });
    function toggleResults(questionId) {
            const dropdown = document.getElementById(`results-content-${questionId}`);
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
            } else {
                fetch(`/question-results/${questionId}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Failed to fetch results');
                        }
                    })
                    .then(data => {
                        const answers = Object.keys(data);
                        const counts = Object.values(data);
                        
                        const labels = answers.map((answer, index) => `Chose ${index}`);

                        // Create a bar chart using Chart.js
                        const ctx = document.createElement('canvas').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Answer Counts',
                                    data: counts,
                                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    yAxes: [{
                                        ticks: {
                                            beginAtZero: true
                                        }
                                    }]
                                }
                            }
                        });

                        // Replace the dropdown content with the chart canvas
                        dropdown.innerHTML = '';
                        dropdown.appendChild(ctx.canvas);
                        dropdown.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error fetching results:', error);
                        dropdown.innerHTML = 'Failed to fetch results';
                        dropdown.style.display = 'block';
                    });
            }
        }


</script>

</body>
</html>