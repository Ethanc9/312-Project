<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../static/css/answer.css">
    <title>Quiz</title>
</head>
<body>
    <div class="header">
        <h1>CSE 312</h1>
        <div class="user-info">
            <span class="username">Welcome, {{ user_name }}, here are your questions:</span>
        </div>
    </div>

    <div id="questions-container">
        {% for question in questions %}
        <div class="question">
            {% if question.image_path %}
            <p>Q:</p>
            <img src="{{ question.image_path }}" alt="Question Image" class="question-image">
            {% endif %}
            {% if question.question %}
            <p>Q: {{ question.question }}</p>
            {% endif %}
            <!-- Display who posted the question -->
            <p>Posted by: {{ question.username }}</p>
            <!-- Display the answer count -->
            <p>Answers submitted: {{ question.answer_count }}</p>
            <form onsubmit="submitAnswer(event, this, '{{ question._id }}'); return false;">
                {% for answer in question.answers %}
                <label class="answer-option">
                    <input type="radio" name="answer-{{ question._id }}" value="{{ loop.index0 }}">
                    {{ answer }}
                </label>
                {% endfor %}
                <button type="submit">Submit Answer</button>
            </form>
        </div>
        {% endfor %}
    </div>
    <script>
        async function submitAnswer(event, form, questionId) {
            event.preventDefault(); // Prevent the default form submission
        
            // Find the selected answer
            const selectedAnswer = form.querySelector(`input[name="answer-${questionId}"]:checked`).value;
        
            // Prepare the data to be sent
            const data = {
                questionId: questionId,
                answerIndex: parseInt(selectedAnswer, 10) // Ensure answerIndex is an integer
            };
        
            try {
                // Send the data using the Fetch API to the correct endpoint
                const response = await fetch('/validate-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
        
                if (response.ok) {
                    // Handle the response from the server
                    const result = await response.json();
                    alert(result.message); // For example, alert the user with the result message
                    // Optionally, redirect or update the UI based on the result
                } else {
                    // Handle server errors or invalid responses
                    console.error('Submission failed', await response.text());
                }
            } catch (error) {
                // Handle network errors
                console.error('Network error:', error);
            }
        }
        </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
    var socket = io();
    socket.on('connect', function() {
        socket.emit('my event', {data: 'I\'m connected!'});
        
    });

    

    // function update_Questions(){
    //     socket.emit('message', {data: 'updating questions...'})
    // }
    // setInterval(update_Questions, 2000);

    socket.on('update_question', function(new_question) {
        console.log(new_question);
        questionJSON = JSON.parse(new_question);
        const oldquestions = document.getElementById("questions-container");
        console.log(questionJSON.answers);
        
        oldquestions.innerHTML += "<div class='question'>\r\n" + "<p>Q: " + questionJSON.question + "</p>" + "<!-- Display who posted the question -->\r\n" + "<p>Posted by: "+ questionJSON.username +"</p>" + "<!-- Display the answer count -->\r\n"+ "<p>Answers submitted: " + questionJSON.answer_count + "</p>\r\n" + "<form onsubmit='submitAnswer(event, this, " + questionJSON._id + "'); return false;'>\r\n{% for answer in "+ questionJSON.answers +"%}\r\n<label class='answer-option'>" + "<input type='radio' name='answer-" + questionJSON._id + "'value='" + questionJSON.correct_answer + " '>\r\n" + questionJSON.answers[questionJSON.correct_answer] + "</label>\r\n{% endfor %}\r\n<button type='submit'>Submit Answer</button>\r\n</form>\r\n</div>"
            
        
        // startinghtml = startinghtml.replace('questions', new_questions)
        // console.log(startinghtml)
        // oldquestions.innerHTML = startinghtml
    });


</script>

</body>
</html>